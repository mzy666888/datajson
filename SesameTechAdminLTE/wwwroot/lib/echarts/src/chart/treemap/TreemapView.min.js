/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/echarts@4.5.0/src/chart/treemap/TreemapView.js
 * 
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import*as echarts from"../../echarts";import*as zrUtil from"zrender/src/core/util";import*as graphic from"../../util/graphic";import DataDiffer from"../../data/DataDiffer";import*as helper from"../helper/treeHelper";import Breadcrumb from"./Breadcrumb";import RoamController from"../../component/helper/RoamController";import BoundingRect from"zrender/src/core/BoundingRect";import*as matrix from"zrender/src/core/matrix";import*as animationUtil from"../../util/animation";import makeStyleMapper from"../../model/mixin/makeStyleMapper";var bind=zrUtil.bind,Group=graphic.Group,Rect=graphic.Rect,each=zrUtil.each,DRAG_THRESHOLD=3,PATH_LABEL_NOAMAL=["label"],PATH_LABEL_EMPHASIS=["emphasis","label"],PATH_UPPERLABEL_NORMAL=["upperLabel"],PATH_UPPERLABEL_EMPHASIS=["emphasis","upperLabel"],Z_BASE=10,Z_BG=1,Z_CONTENT=2,getItemStyleEmphasis=makeStyleMapper([["fill","color"],["stroke","strokeColor"],["lineWidth","strokeWidth"],["shadowBlur"],["shadowOffsetX"],["shadowOffsetY"],["shadowColor"]]),getItemStyleNormal=function(e){var t=getItemStyleEmphasis(e);return t.stroke=t.fill=t.lineWidth=null,t};export default echarts.extendChartView({type:"treemap",init:function(e,t){this._containerGroup,this._storage=createStorage(),this._oldTree,this._breadcrumb,this._controller,this._state="ready"},render:function(e,t,i,o){var r=t.findComponents({mainType:"series",subType:"treemap",query:o});if(!(zrUtil.indexOf(r,e)<0)){this.seriesModel=e,this.api=i,this.ecModel=t;var n=helper.retrieveTargetInfo(o,["treemapZoomToNode","treemapRootToNode"],e),a=o&&o.type,s=e.layoutInfo,l=!this._oldTree,d=this._storage,h="treemapRootToNode"===a&&n&&d?{rootNodeGroup:d.nodeGroup[n.node.getRawIndex()],direction:o.direction}:null,c=this._giveContainerGroup(s),u=this._doRender(c,e,h);l||a&&"treemapZoomToNode"!==a&&"treemapRootToNode"!==a?u.renderFinally():this._doAnimation(c,u,e,h),this._resetController(i),this._renderBreadcrumb(e,i,n)}},_giveContainerGroup:function(e){var t=this._containerGroup;return t||(t=this._containerGroup=new Group,this._initEvents(t),this.group.add(t)),t.attr("position",[e.x,e.y]),t},_doRender:function(e,t,i){var o=t.getData().tree,r=this._oldTree,n=createStorage(),a=createStorage(),s=this._storage,l=[],d=zrUtil.curry(renderNode,t,a,s,i,n,l);!function e(t,i,o,r,n){r?(i=t,each(t,function(e,t){!e.isRemoved()&&s(t,t)})):new DataDiffer(i,t,a,a).add(s).update(s).remove(zrUtil.curry(s,null)).execute();function a(e){return e.getId()}function s(a,s){var l=null!=a?t[a]:null,h=null!=s?i[s]:null,c=d(l,h,o,n);c&&e(l&&l.viewChildren||[],h&&h.viewChildren||[],c,r,n+1)}}(o.root?[o.root]:[],r&&r.root?[r.root]:[],e,o===r||!r,0);var h=function(e){var t=createStorage();return e&&each(e,function(e,i){var o=t[i];each(e,function(e){e&&(o.push(e),e.__tmWillDelete=1)})}),t}(s);return this._oldTree=o,this._storage=a,{lastsForAnimation:n,willDeleteEls:h,renderFinally:function(){each(h,function(e){each(e,function(e){e.parent&&e.parent.remove(e)})}),each(l,function(e){e.invisible=!0,e.dirty()})}}},_doAnimation:function(e,t,i,o){if(i.get("animation")){var r=i.get("animationDurationUpdate"),n=i.get("animationEasing"),a=animationUtil.createWrap();each(t.willDeleteEls,function(e,t){each(e,function(e,i){if(!e.invisible){var s,l=e.parent;if(o&&"drillDown"===o.direction)s=l===o.rootNodeGroup?{shape:{x:0,y:0,width:l.__tmNodeWidth,height:l.__tmNodeHeight},style:{opacity:0}}:{style:{opacity:0}};else{var d=0,h=0;l.__tmWillDelete||(d=l.__tmNodeWidth/2,h=l.__tmNodeHeight/2),s="nodeGroup"===t?{position:[d,h],style:{opacity:0}}:{shape:{x:d,y:h,width:0,height:0},style:{opacity:0}}}s&&a.add(e,s,r,n)}})}),each(this._storage,function(e,i){each(e,function(e,o){var s=t.lastsForAnimation[i][o],l={};s&&("nodeGroup"===i?s.old&&(l.position=e.position.slice(),e.attr("position",s.old)):(s.old&&(l.shape=zrUtil.extend({},e.shape),e.setShape(s.old)),s.fadein?(e.setStyle("opacity",0),l.style={opacity:1}):1!==e.style.opacity&&(l.style={opacity:1})),a.add(e,l,r,n))})},this),this._state="animating",a.done(bind(function(){this._state="ready",t.renderFinally()},this)).start()}},_resetController:function(e){var t=this._controller;t||((t=this._controller=new RoamController(e.getZr())).enable(this.seriesModel.get("roam")),t.on("pan",bind(this._onPan,this)),t.on("zoom",bind(this._onZoom,this)));var i=new BoundingRect(0,0,e.getWidth(),e.getHeight());t.setPointerChecker(function(e,t,o){return i.contain(t,o)})},_clearController:function(){var e=this._controller;e&&(e.dispose(),e=null)},_onPan:function(e){if("animating"!==this._state&&(Math.abs(e.dx)>DRAG_THRESHOLD||Math.abs(e.dy)>DRAG_THRESHOLD)){var t=this.seriesModel.getData().tree.root;if(!t)return;var i=t.getLayout();if(!i)return;this.api.dispatchAction({type:"treemapMove",from:this.uid,seriesId:this.seriesModel.id,rootRect:{x:i.x+e.dx,y:i.y+e.dy,width:i.width,height:i.height}})}},_onZoom:function(e){var t=e.originX,i=e.originY;if("animating"!==this._state){var o=this.seriesModel.getData().tree.root;if(!o)return;var r=o.getLayout();if(!r)return;var n=new BoundingRect(r.x,r.y,r.width,r.height),a=this.seriesModel.layoutInfo;t-=a.x,i-=a.y;var s=matrix.create();matrix.translate(s,s,[-t,-i]),matrix.scale(s,s,[e.scale,e.scale]),matrix.translate(s,s,[t,i]),n.applyTransform(s),this.api.dispatchAction({type:"treemapRender",from:this.uid,seriesId:this.seriesModel.id,rootRect:{x:n.x,y:n.y,width:n.width,height:n.height}})}},_initEvents:function(e){e.on("click",function(e){if("ready"===this._state){var t=this.seriesModel.get("nodeClick",!0);if(t){var i=this.findTarget(e.offsetX,e.offsetY);if(i){var o=i.node;if(o.getLayout().isLeafRoot)this._rootToNode(i);else if("zoomToNode"===t)this._zoomToNode(i);else if("link"===t){var r=o.hostTree.data.getItemModel(o.dataIndex),n=r.get("link",!0),a=r.get("target",!0)||"blank";n&&window.open(n,a)}}}}},this)},_renderBreadcrumb:function(e,t,i){i||(i=null!=e.get("leafDepth",!0)?{node:e.getViewRoot()}:this.findTarget(t.getWidth()/2,t.getHeight()/2))||(i={node:e.getData().tree.root}),(this._breadcrumb||(this._breadcrumb=new Breadcrumb(this.group))).render(e,t,i.node,bind(function(t){"animating"!==this._state&&(helper.aboveViewRoot(e.getViewRoot(),t)?this._rootToNode({node:t}):this._zoomToNode({node:t}))},this))},remove:function(){this._clearController(),this._containerGroup&&this._containerGroup.removeAll(),this._storage=createStorage(),this._state="ready",this._breadcrumb&&this._breadcrumb.remove()},dispose:function(){this._clearController()},_zoomToNode:function(e){this.api.dispatchAction({type:"treemapZoomToNode",from:this.uid,seriesId:this.seriesModel.id,targetNode:e.node})},_rootToNode:function(e){this.api.dispatchAction({type:"treemapRootToNode",from:this.uid,seriesId:this.seriesModel.id,targetNode:e.node})},findTarget:function(e,t){var i;return this.seriesModel.getViewRoot().eachNode({attr:"viewChildren",order:"preorder"},function(o){var r=this._storage.background[o.getRawIndex()];if(r){var n=r.transformCoordToLocal(e,t),a=r.shape;if(!(a.x<=n[0]&&n[0]<=a.x+a.width&&a.y<=n[1]&&n[1]<=a.y+a.height))return!1;i={node:o,offsetX:n[0],offsetY:n[1]}}},this),i}});function createStorage(){return{nodeGroup:[],background:[],content:[]}}function renderNode(e,t,i,o,r,n,a,s,l,d){if(a){var h=a.getLayout();if(h&&h.isInView){var c=h.width,u=h.height,p=h.borderWidth,m=h.invisible,f=a.getRawIndex(),g=s&&s.getRawIndex(),_=a.viewChildren,y=h.upperHeight,v=_&&_.length,x=a.getModel("itemStyle"),w=a.getModel("emphasis.itemStyle"),b=N("nodeGroup",Group);if(b){if(l.add(b),b.attr("position",[h.x||0,h.y||0]),b.__tmNodeWidth=c,b.__tmNodeHeight=u,h.isAboveViewRoot)return b;var R=N("background",Rect,d,Z_BG);if(R&&function(t,i,o){i.dataIndex=a.dataIndex,i.seriesIndex=e.seriesIndex,i.setShape({x:0,y:0,width:c,height:u});var r=a.getVisual("borderColor",!0),n=w.get("borderColor");S(i,function(){var e=getItemStyleNormal(x);e.fill=r;var t=getItemStyleEmphasis(w);if(t.fill=n,o){var a=c-2*p;A(e,t,r,a,y,{x:p,y:0,width:a,height:y})}else e.text=t.text=null;i.setStyle(e),graphic.setHoverStyle(i,t)}),t.add(i)}(b,R,v&&h.upperHeight),!v){var T=N("content",Rect,d,Z_CONTENT);T&&function(t,i){i.dataIndex=a.dataIndex,i.seriesIndex=e.seriesIndex;var o=Math.max(c-2*p,0),r=Math.max(u-2*p,0);i.culling=!0,i.setShape({x:p,y:p,width:o,height:r});var n=a.getVisual("color",!0);S(i,function(){var e=getItemStyleNormal(x);e.fill=n;var t=getItemStyleEmphasis(w);A(e,t,n,o,r),i.setStyle(e),graphic.setHoverStyle(i,t)}),t.add(i)}(b,T)}return b}}}function S(e,t){m?!e.invisible&&n.push(e):(t(),e.__tmWillVisible||(e.invisible=!1))}function A(t,i,o,r,n,s){var l=a.getModel(),d=zrUtil.retrieve(e.getFormattedLabel(a.dataIndex,"normal",null,null,s?"upperLabel":"label"),l.get("name"));if(!s&&h.isLeafRoot){var c=e.get("drillDownIcon",!0);d=c?c+" "+d:d}var u=l.getModel(s?PATH_UPPERLABEL_NORMAL:PATH_LABEL_NOAMAL),p=l.getModel(s?PATH_UPPERLABEL_EMPHASIS:PATH_LABEL_EMPHASIS),m=u.getShallow("show");graphic.setLabelStyle(t,i,u,p,{defaultText:m?d:null,autoColor:o,isRectText:!0}),s&&(t.textRect=zrUtil.clone(s)),t.truncate=m&&u.get("ellipsis")?{outerWidth:r,outerHeight:n,minChar:2}:null}function N(e,n,s,l){var d=null!=g&&i[e][g],h=r[e];return d?(i[e][g]=null,function(e,t,i){(e[f]={}).old="nodeGroup"===i?t.position.slice():zrUtil.extend({},t.shape)}(h,d,e)):m||((d=new n({z:calculateZ(s,l)})).__tmDepth=s,d.__tmStorageName=e,function(e,t,i){var n=e[f]={},s=a.parentNode;if(s&&(!o||"drillDown"===o.direction)){var l=0,d=0,h=r.background[s.getRawIndex()];!o&&h&&h.old&&(l=h.old.width,d=h.old.height),n.old="nodeGroup"===i?[0,d]:{x:l,y:d,width:0,height:0}}n.fadein="nodeGroup"!==i}(h,0,e)),t[e][f]=d}}function calculateZ(e,t){var i=e*Z_BASE+t;return(i-1)/i}
//# sourceMappingURL=/sm/1a592a91cbdff305769f13a0e211dae073368ed35e9103de7b8208eac5afa057.map