/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/echarts@4.5.0/src/stream/Scheduler.js
 * 
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{each,map,isFunction,createHashMap,noop}from"zrender/src/core/util";import{createTask}from"./task";import{getUID}from"../util/component";import GlobalModel from"../model/Global";import ExtensionAPI from"../ExtensionAPI";import{normalizeToArray}from"../util/model";function Scheduler(e,t,a,r){this.ecInstance=e,this.api=t,this.unfinished;a=this._dataProcessorHandlers=a.slice(),r=this._visualHandlers=r.slice();this._allHandlers=a.concat(r),this._stageTaskMap=createHashMap()}var proto=Scheduler.prototype;function performStageTasks(e,t,a,r,s){var i;function o(e,t){return e.setDirty&&(!e.dirtyMap||e.dirtyMap.get(t.__pipeline.id))}s=s||{},each(t,function(t,n){if(!s.visualType||s.visualType===t.visualType){var l=e._stageTaskMap.get(t.uid),p=l.seriesTaskMap,c=l.overallTask;if(c){var u,d=c.agentStubMap;d.each(function(e){o(s,e)&&(e.dirty(),u=!0)}),u&&c.dirty(),updatePayload(c,r);var h=e.getPerformArgs(c,s.block);d.each(function(e){e.perform(h)}),i|=c.perform(h)}else p&&p.each(function(n,l){o(s,n)&&n.dirty();var p=e.getPerformArgs(n,s.block);p.skip=!t.performRawSeries&&a.isSeriesFiltered(n.context.model),updatePayload(n,r),i|=n.perform(p)})}}),e.unfinished|=i}proto.restoreData=function(e,t){e.restoreData(t),this._stageTaskMap.each(function(e){var t=e.overallTask;t&&t.dirty()})},proto.getPerformArgs=function(e,t){if(e.__pipeline){var a=this._pipelineMap.get(e.__pipeline.id),r=a.context,s=!t&&a.progressiveEnabled&&(!r||r.progressiveRender)&&e.__idxInPipeline>a.blockIndex?a.step:null,i=r&&r.modDataCount;return{step:s,modBy:null!=i?Math.ceil(i/s):null,modDataCount:i}}},proto.getPipeline=function(e){return this._pipelineMap.get(e)},proto.updateStreamModes=function(e,t){var a=this._pipelineMap.get(e.uid),r=e.getData().count(),s=a.progressiveEnabled&&t.incrementalPrepareRender&&r>=a.threshold,i=e.get("large")&&r>=e.get("largeThreshold"),o="mod"===e.get("progressiveChunkMode")?r:null;e.pipelineContext=a.context={progressiveRender:s,modDataCount:o,large:i}},proto.restorePipelines=function(e){var t=this,a=t._pipelineMap=createHashMap();e.eachSeries(function(e){var r=e.getProgressive(),s=e.uid;a.set(s,{id:s,head:null,tail:null,threshold:e.getProgressiveThreshold(),progressiveEnabled:r&&!(e.preventIncremental&&e.preventIncremental()),blockIndex:-1,step:Math.round(r||700),count:0}),pipe(t,e,e.dataTask)})},proto.prepareStageTasks=function(){var e=this._stageTaskMap,t=this.ecInstance.getModel(),a=this.api;each(this._allHandlers,function(r){var s=e.get(r.uid)||e.set(r.uid,[]);r.reset&&createSeriesStageTask(this,r,s,t,a),r.overallReset&&createOverallStageTask(this,r,s,t,a)},this)},proto.prepareView=function(e,t,a,r){var s=e.renderTask,i=s.context;i.model=t,i.ecModel=a,i.api=r,s.__block=!e.incrementalPrepareRender,pipe(this,t,s)},proto.performDataProcessorTasks=function(e,t){performStageTasks(this,this._dataProcessorHandlers,e,t,{block:!0})},proto.performVisualTasks=function(e,t,a){performStageTasks(this,this._visualHandlers,e,t,a)},proto.performSeriesTasks=function(e){var t;e.eachSeries(function(e){t|=e.dataTask.perform()}),this.unfinished|=t},proto.plan=function(){this._pipelineMap.each(function(e){var t=e.tail;do{if(t.__block){e.blockIndex=t.__idxInPipeline;break}t=t.getUpstream()}while(t)})};var updatePayload=proto.updatePayload=function(e,t){"remain"!==t&&(e.context.payload=t)};function createSeriesStageTask(e,t,a,r,s){var i=a.seriesTaskMap||(a.seriesTaskMap=createHashMap()),o=t.seriesType,n=t.getTargetSeries;function l(a){var o=a.uid,n=i.get(o)||i.set(o,createTask({plan:seriesTaskPlan,reset:seriesTaskReset,count:seriesTaskCount}));n.context={model:a,ecModel:r,api:s,useClearVisual:t.isVisual&&!t.isLayout,plan:t.plan,reset:t.reset,scheduler:e},pipe(e,a,n)}t.createOnAllSeries?r.eachRawSeries(l):o?r.eachRawSeriesByType(o,l):n&&n(r,s).each(l);var p=e._pipelineMap;i.each(function(e,t){p.get(t)||(e.dispose(),i.removeKey(t))})}function createOverallStageTask(e,t,a,r,s){var i=a.overallTask=a.overallTask||createTask({reset:overallTaskReset});i.context={ecModel:r,api:s,overallReset:t.overallReset,scheduler:e};var o=i.agentStubMap=i.agentStubMap||createHashMap(),n=t.seriesType,l=t.getTargetSeries,p=!0,c=t.modifyOutputEnd;function u(t){var a=t.uid,r=o.get(a);r||(r=o.set(a,createTask({reset:stubReset,onDirty:stubOnDirty})),i.dirty()),r.context={model:t,overallProgress:p,modifyOutputEnd:c},r.agent=i,r.__block=p,pipe(e,t,r)}n?r.eachRawSeriesByType(n,u):l?l(r,s).each(u):(p=!1,each(r.getSeries(),u));var d=e._pipelineMap;o.each(function(e,t){d.get(t)||(e.dispose(),i.dirty(),o.removeKey(t))})}function overallTaskReset(e){e.overallReset(e.ecModel,e.api,e.payload)}function stubReset(e,t){return e.overallProgress&&stubProgress}function stubProgress(){this.agent.dirty(),this.getDownstream().dirty()}function stubOnDirty(){this.agent&&this.agent.dirty()}function seriesTaskPlan(e){return e.plan&&e.plan(e.model,e.ecModel,e.api,e.payload)}function seriesTaskReset(e){e.useClearVisual&&e.data.clearAllVisual();var t=e.resetDefines=normalizeToArray(e.reset(e.model,e.ecModel,e.api,e.payload));return t.length>1?map(t,function(e,t){return makeSeriesTaskProgress(t)}):singleSeriesTaskProgress}var singleSeriesTaskProgress=makeSeriesTaskProgress(0);function makeSeriesTaskProgress(e){return function(t,a){var r=a.data,s=a.resetDefines[e];if(s&&s.dataEach)for(var i=t.start;i<t.end;i++)s.dataEach(r,i);else s&&s.progress&&s.progress(t,r)}}function seriesTaskCount(e){return e.data.count()}function pipe(e,t,a){var r=t.uid,s=e._pipelineMap.get(r);!s.head&&(s.head=a),s.tail&&s.tail.pipe(a),s.tail=a,a.__idxInPipeline=s.count++,a.__pipeline=s}function detectSeriseType(e){seriesType=null;try{e(ecModelMock,apiMock)}catch(e){}return seriesType}Scheduler.wrapStageHandler=function(e,t){return isFunction(e)&&(e={overallReset:e,seriesType:detectSeriseType(e)}),e.uid=getUID("stageHandler"),t&&(e.visualType=t),e};var seriesType,ecModelMock={},apiMock={};function mockMethods(e,t){for(var a in t.prototype)e[a]=noop}mockMethods(ecModelMock,GlobalModel),mockMethods(apiMock,ExtensionAPI),ecModelMock.eachSeriesByType=ecModelMock.eachRawSeriesByType=function(e){seriesType=e},ecModelMock.eachComponent=function(e){"series"===e.mainType&&e.subType&&(seriesType=e.subType)};export default Scheduler;
//# sourceMappingURL=/sm/375a3bf5c8a43df07dedd460ca137988dfe457f1cbbf7869efa1c4048373a9ef.map