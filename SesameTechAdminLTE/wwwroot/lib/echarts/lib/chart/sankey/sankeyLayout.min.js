/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/echarts@4.5.0/lib/chart/sankey/sankeyLayout.js
 * 
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var layout=require("../../util/layout"),zrUtil=require("zrender/lib/core/util"),_model=require("../../util/model"),groupData=_model.groupData;function _default(t,e,a){t.eachSeriesByType("sankey",function(t){var a=t.get("nodeWidth"),o=t.get("nodeGap"),u=getViewRect(t,e);t.layoutInfo=u;var n=u.width,r=u.height,i=t.getGraph(),g=i.nodes,l=i.edges;computeNodeValues(g),layoutSankey(g,l,a,o,n,r,0!==zrUtil.filter(g,function(t){return 0===t.getLayout().value}).length?0:t.get("layoutIterations"),t.get("orient"),t.get("nodeAlign"))})}function getViewRect(t,e){return layout.getLayoutRect(t.getBoxLayoutParams(),{width:e.getWidth(),height:e.getHeight()})}function layoutSankey(t,e,a,o,u,n,r,i,g){computeNodeBreadths(t,e,a,u,n,i,g),computeNodeDepths(t,e,n,u,o,r,i),computeEdgeDepths(t,i)}function computeNodeValues(t){zrUtil.each(t,function(t){var e=sum(t.outEdges,getEdgeValue),a=sum(t.inEdges,getEdgeValue),o=Math.max(e,a);t.setLayout({value:o},!0)})}function computeNodeBreadths(t,e,a,o,u,n,r){for(var i=[],g=[],l=[],d=[],s=0,c=0;c<e.length;c++)i[c]=1;for(c=0;c<t.length;c++)g[c]=t[c].inEdges.length,0===g[c]&&l.push(t[c]);for(var h=-1;l.length;){for(var y=0;y<l.length;y++){var f=l[y],v=f.hostGraph.data.getRawDataItem(f.dataIndex),L=null!=v.depth&&v.depth>=0;L&&v.depth>h&&(h=v.depth),f.setLayout({depth:L?v.depth:s},!0),"vertical"===n?f.setLayout({dy:a},!0):f.setLayout({dx:a},!0);for(var p=0;p<f.outEdges.length;p++){var x=f.outEdges[p];i[e.indexOf(x)]=0;var m=x.node2;0==--g[t.indexOf(m)]&&d.indexOf(m)<0&&d.push(m)}}++s,l=d,d=[]}for(c=0;c<i.length;c++)if(1===i[c])throw new Error("Sankey is a DAG, the original data has cycle!");var E=h>s-1?h:s-1;r&&"left"!==r&&adjustNodeWithNodeAlign(t,r,n,E),scaleNodeBreadths(t,"vertical"===n?(u-a)/E:(o-a)/E,n)}function isNodeDepth(t){var e=t.hostGraph.data.getRawDataItem(t.dataIndex);return null!=e.depth&&e.depth>=0}function adjustNodeWithNodeAlign(t,e,a,o){if("right"===e){for(var u=[],n=t,r=0;n.length;){for(var i=0;i<n.length;i++){var g=n[i];g.setLayout({skNodeHeight:r},!0);for(var l=0;l<g.inEdges.length;l++){var d=g.inEdges[l];u.indexOf(d.node1)<0&&u.push(d.node1)}}n=u,u=[],++r}zrUtil.each(t,function(t){isNodeDepth(t)||t.setLayout({depth:Math.max(0,o-t.getLayout().skNodeHeight)},!0)})}else"justify"===e&&moveSinksRight(t,o)}function moveSinksRight(t,e){zrUtil.each(t,function(t){isNodeDepth(t)||t.outEdges.length||t.setLayout({depth:e},!0)})}function scaleNodeBreadths(t,e,a){zrUtil.each(t,function(t){var o=t.getLayout().depth*e;"vertical"===a?t.setLayout({y:o},!0):t.setLayout({x:o},!0)})}function computeNodeDepths(t,e,a,o,u,n,r){var i=prepareNodesByBreadth(t,r);initializeNodeDepth(i,e,a,o,u,r),resolveCollisions(i,u,a,o,r);for(var g=1;n>0;n--)relaxRightToLeft(i,g*=.99,r),resolveCollisions(i,u,a,o,r),relaxLeftToRight(i,g,r),resolveCollisions(i,u,a,o,r)}function prepareNodesByBreadth(t,e){var a=[],o="vertical"===e?"y":"x",u=groupData(t,function(t){return t.getLayout()[o]});return u.keys.sort(function(t,e){return t-e}),zrUtil.each(u.keys,function(t){a.push(u.buckets.get(t))}),a}function initializeNodeDepth(t,e,a,o,u,n){var r=1/0;zrUtil.each(t,function(t){var e=t.length,i=0;zrUtil.each(t,function(t){i+=t.getLayout().value});var g="vertical"===n?(o-(e-1)*u)/i:(a-(e-1)*u)/i;g<r&&(r=g)}),zrUtil.each(t,function(t){zrUtil.each(t,function(t,e){var a=t.getLayout().value*r;"vertical"===n?(t.setLayout({x:e},!0),t.setLayout({dx:a},!0)):(t.setLayout({y:e},!0),t.setLayout({dy:a},!0))})}),zrUtil.each(e,function(t){var e=+t.getValue()*r;t.setLayout({dy:e},!0)})}function resolveCollisions(t,e,a,o,u){var n="vertical"===u?"x":"y";zrUtil.each(t,function(t){var r,i,g;t.sort(function(t,e){return t.getLayout()[n]-e.getLayout()[n]});for(var l=0,d=t.length,s="vertical"===u?"dx":"dy",c=0;c<d;c++)(g=l-(i=t[c]).getLayout()[n])>0&&(r=i.getLayout()[n]+g,"vertical"===u?i.setLayout({x:r},!0):i.setLayout({y:r},!0)),l=i.getLayout()[n]+i.getLayout()[s]+e;if((g=l-e-("vertical"===u?o:a))>0)for(r=i.getLayout()[n]-g,"vertical"===u?i.setLayout({x:r},!0):i.setLayout({y:r},!0),l=r,c=d-2;c>=0;--c)(g=(i=t[c]).getLayout()[n]+i.getLayout()[s]+e-l)>0&&(r=i.getLayout()[n]-g,"vertical"===u?i.setLayout({x:r},!0):i.setLayout({y:r},!0)),l=i.getLayout()[n]})}function relaxRightToLeft(t,e,a){zrUtil.each(t.slice().reverse(),function(t){zrUtil.each(t,function(t){if(t.outEdges.length){var o=sum(t.outEdges,weightedTarget,a)/sum(t.outEdges,getEdgeValue,a);if("vertical"===a){var u=t.getLayout().x+(o-center(t,a))*e;t.setLayout({x:u},!0)}else{var n=t.getLayout().y+(o-center(t,a))*e;t.setLayout({y:n},!0)}}})})}function weightedTarget(t,e){return center(t.node2,e)*t.getValue()}function weightedSource(t,e){return center(t.node1,e)*t.getValue()}function center(t,e){return"vertical"===e?t.getLayout().x+t.getLayout().dx/2:t.getLayout().y+t.getLayout().dy/2}function getEdgeValue(t){return t.getValue()}function sum(t,e,a){for(var o=0,u=t.length,n=-1;++n<u;){var r=+e.call(t,t[n],a);isNaN(r)||(o+=r)}return o}function relaxLeftToRight(t,e,a){zrUtil.each(t,function(t){zrUtil.each(t,function(t){if(t.inEdges.length){var o=sum(t.inEdges,weightedSource,a)/sum(t.inEdges,getEdgeValue,a);if("vertical"===a){var u=t.getLayout().x+(o-center(t,a))*e;t.setLayout({x:u},!0)}else{var n=t.getLayout().y+(o-center(t,a))*e;t.setLayout({y:n},!0)}}})})}function computeEdgeDepths(t,e){var a="vertical"===e?"x":"y";zrUtil.each(t,function(t){t.outEdges.sort(function(t,e){return t.node2.getLayout()[a]-e.node2.getLayout()[a]}),t.inEdges.sort(function(t,e){return t.node1.getLayout()[a]-e.node1.getLayout()[a]})}),zrUtil.each(t,function(t){var e=0,a=0;zrUtil.each(t.outEdges,function(t){t.setLayout({sy:e},!0),e+=t.getLayout().dy}),zrUtil.each(t.inEdges,function(t){t.setLayout({ty:a},!0),a+=t.getLayout().dy})})}module.exports=_default;
//# sourceMappingURL=/sm/8c28a02a61fdf783438b125ea07e960da57e8189ef7cd66e6f75eddc85b4dda1.map